<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Reset Password - ShopHub</title>
	<link rel="stylesheet" href="styles.css">
</head>
<body>
	<div class="auth-container">
		<div class="auth-card">
			<div class="auth-header">
				<div class="auth-logo">
					<div class="logo-icon">üõçÔ∏è</div>
					<h1>ShopHub</h1>
				</div>
				<h2>Reset Password</h2>
				<p>Enter your new password and the reset code sent to your email</p>
			</div>
			
			<form id="reset-form" class="auth-form">
				<div class="form-group">
					<label for="email" class="required">Email Address</label>
					<input type="email" id="email" name="email" required placeholder="Enter your email" readonly>
					<div class="error-message" id="email-error"></div>
				</div>
				
				<div class="form-group">
					<label for="code" class="required">Reset Code</label>
					<input type="text" id="code" name="code" required placeholder="Enter 6-digit code" maxlength="6">
					<div class="error-message" id="code-error"></div>
					<div class="code-info">
						<span id="timer">Code expires in: 60s</span>
						<button type="button" id="resend-code" class="resend-btn">Resend Code</button>
					</div>
				</div>
				
				<div class="form-group">
					<label for="password" class="required">New Password</label>
					<div class="password-input">
						<input type="password" id="password" name="password" required placeholder="Enter new password">
						<button type="button" class="password-toggle" id="password-toggle">üëÅÔ∏è</button>
					</div>
					<div class="password-strength" id="password-strength">
						<div class="strength-bar">
							<div class="strength-fill" id="strength-fill"></div>
						</div>
						<div class="strength-text" id="strength-text">Password strength</div>
					</div>
					<div class="error-message" id="password-error"></div>
				</div>

				<div class="form-group">
					<label for="confirm-password" class="required">Confirm Password</label>
					<div class="password-input">
						<input type="password" id="confirm-password" name="confirm-password" required placeholder="Confirm new password">
						<button type="button" class="password-toggle" id="confirm-password-toggle">üëÅÔ∏è</button>
					</div>
					<div class="error-message" id="confirm-password-error"></div>
				</div>
				
				<button type="submit" class="auth-btn primary">
					<span class="btn-text">Reset Password</span>
					<span class="btn-loading" id="reset-loading">‚è≥</span>
				</button>
			</form>
			
			<div class="auth-footer">
				<p>Remember your password? <a href="login.html">Sign in</a></p>
			</div>
		</div>
	</div>
	
	<script src="email-service.js"></script>
	<script src="auth.js"></script>
	<script src="validation.js"></script>
	<script>
		let timeLeft = 600; // 10 minutes
		let timerInterval;
		
		// Get email and code from URL parameters
		const urlParams = new URLSearchParams(window.location.search);
		const email = urlParams.get('email');
		const code = urlParams.get('code');
		
		// Set email field
		if (email) {
			document.getElementById('email').value = email;
		}
		
		// Set code field
		if (code) {
			document.getElementById('code').value = code;
		}
		
		// If both email and code are present, auto-validate
		if (email && code) {
			const isValid = window.Auth.verifyResetCode(email, code);
			if (isValid) {
				document.getElementById('code').style.borderColor = '#22c55e';
				document.getElementById('code').style.backgroundColor = 'rgba(34,197,94,0.1)';
			} else {
				document.getElementById('code').style.borderColor = '#ef4444';
				document.getElementById('code').style.backgroundColor = 'rgba(239,68,68,0.1)';
			}
		}
		
		// Start countdown timer
		function startTimer() {
			timerInterval = setInterval(() => {
				timeLeft--;
				const minutes = Math.floor(timeLeft / 60);
				const seconds = timeLeft % 60;
				document.getElementById('timer').textContent = `Code expires in: ${minutes}:${seconds.toString().padStart(2, '0')}`;
				
				if (timeLeft <= 0) {
					clearInterval(timerInterval);
					document.getElementById('timer').textContent = 'Code expired';
					document.getElementById('timer').style.color = 'var(--danger)';
					document.getElementById('resend-code').style.display = 'inline-block';
				}
			}, 1000);
		}
		
		// Resend code
		document.getElementById('resend-code').addEventListener('click', async () => {
			const email = document.getElementById('email').value;
			if (!email) {
				alert('Please enter your email address');
				return;
			}
			
			try {
				const result = await window.Auth.sendPasswordResetEmail(email);
				if (result.success) {
					alert(result.message);
					timeLeft = 60;
					document.getElementById('timer').textContent = `Code expires in: ${timeLeft}s`;
					document.getElementById('timer').style.color = 'var(--text)';
					document.getElementById('resend-code').style.display = 'none';
					startTimer();
				}
			} catch (error) {
				alert('Error: ' + error.message);
			}
		});
		
		// Password strength checker
		function checkPasswordStrength(password) {
			let strength = 0;
			const strengthText = document.getElementById('strength-text');
			const strengthFill = document.getElementById('strength-fill');
			
			if (password.length >= 8) strength++;
			if (/[a-z]/.test(password)) strength++;
			if (/[A-Z]/.test(password)) strength++;
			if (/[0-9]/.test(password)) strength++;
			if (/[^A-Za-z0-9]/.test(password)) strength++;
			
			const strengthLevels = ['Very Weak', 'Weak', 'Fair', 'Good', 'Strong'];
			const strengthColors = ['#ff4444', '#ff8800', '#ffbb00', '#88cc00', '#00aa00'];
			
			strengthText.textContent = strengthLevels[strength] || 'Very Weak';
			strengthFill.style.width = `${(strength / 5) * 100}%`;
			strengthFill.style.backgroundColor = strengthColors[strength] || '#ff4444';
		}
		
		// Password toggle
		document.getElementById('password-toggle').addEventListener('click', function() {
			const passwordInput = document.getElementById('password');
			const toggle = this;
			if (passwordInput.type === 'password') {
				passwordInput.type = 'text';
				toggle.textContent = 'üôà';
			} else {
				passwordInput.type = 'password';
				toggle.textContent = 'üëÅÔ∏è';
			}
		});
		
		document.getElementById('confirm-password-toggle').addEventListener('click', function() {
			const passwordInput = document.getElementById('confirm-password');
			const toggle = this;
			if (passwordInput.type === 'password') {
				passwordInput.type = 'text';
				toggle.textContent = 'üôà';
			} else {
				passwordInput.type = 'password';
				toggle.textContent = 'üëÅÔ∏è';
			}
		});
		
		// Real-time password strength checking
		document.getElementById('password').addEventListener('input', function() {
			checkPasswordStrength(this.value);
		});
		
		// Reset form
		document.getElementById('reset-form').addEventListener('submit', async (e) => {
			e.preventDefault();
			
			const formData = new FormData(e.target);
			const email = formData.get('email');
			const code = formData.get('code');
			const password = formData.get('password');
			const confirmPassword = formData.get('confirm-password');
			const loading = document.getElementById('reset-loading');
			const btnText = document.querySelector('#reset-form .btn-text');
			
			// Clear previous errors
			document.querySelectorAll('.error-message').forEach(el => el.textContent = '');
			
			// Validation
			if (!email || !code || !password || !confirmPassword) {
				alert('Please fill in all fields');
				return;
			}
			
			if (code.length !== 6) {
				document.getElementById('code-error').textContent = 'Reset code must be 6 digits';
				return;
			}
			
			if (password.length < 8) {
				document.getElementById('password-error').textContent = 'Password must be at least 8 characters';
				return;
			}
			
			if (password !== confirmPassword) {
				document.getElementById('confirm-password-error').textContent = 'Passwords do not match';
				return;
			}
			
			loading.style.display = 'inline';
			btnText.style.display = 'none';
			
			try {
				const result = await window.Auth.resetPassword(email, code, password);
				if (result.success) {
					alert('Password reset successfully! Redirecting to login...');
					setTimeout(() => {
						window.location.href = 'login.html';
					}, 2000);
				} else {
					alert('Error: ' + result.message);
				}
			} catch (error) {
				alert('Error: ' + error.message);
			} finally {
				loading.style.display = 'none';
				btnText.style.display = 'inline';
			}
		});
		
		// Start timer on page load
		startTimer();
	</script>
</body>
</html>
